# Summary of the data flow

Norway has three different frameworks within which the ecological status of freshwater and coastal water systems is assessed and reported.
One is is EU's [Water Framework Directive](https://eur-lex.europa.eu/legal-content/EN/TXT/?uri=CELEX:32000L0060) ("**WFD**", hereafter), or, more specifically, its Norwegian implementation (_[vannforskriften](https://lovdata.no/dokument/SF/forskrift/2006-12-15-1446)_, "**VF**").
The second is the so-called [Nature Index for Norway](https://www.naturindeks.no/) ("**NI**").
The third and most recent is Ecological Condition Accounting ("**ECA**") following [SEEA&nbsp;EA](https://seea.un.org/ecosystem-accounting). 

All measurements made in connection with the WFD in Norway are archived in a specialised database called _[vannmiljø](https://vannmiljo.miljodirektoratet.no/)_.
The WFD indicators (or "parameters" in WFD parlance) used in Norway, including their definitions, measurement and class boundaries, are described in official [guidelines](https://www.vannportalen.no/veiledere/klassifiseringsveileder/) (in Norwegian).
Several of the WFD indicators have been adopted for the NI and the ECA as well. 
These indicators should ideally give compatible assessments of water status, irrespective of the framework they are reported in. 
To ensure this, and based on previous analyses and recommendations ([Schartau et al. 2016](http://hdl.handle.net/11250/2384734), [Gundersen et al. 2018](http://hdl.handle.net/11250/2584222)), Sandvik ([2019](http://hdl.handle.net/11250/2631056)) has described a dataflow from the WFD to the NI. 
The same dataflow is applicable when WFD data are to be used in connection with ECA (see [Fremstad et al. 2023](https://hdl.handle.net/11250/3104185)). 
The dataflow is implemented in the [**R** code](../R/) of this GitHub repository and briefly summarised on this very page.

Several datasets are required for this end, some of which are available in machine-readable format, whereas others need to be downloaded manually prior to the dataflow:

* The **measurements** of WFD parameters and the information on **water localities** (_vannlokaliteter_) are available from the _[vannmiljø](https://vannmiljo.miljodirektoratet.no/)_ database. They are read from an [API](https://vannmiljowebapi.miljodirektoratet.no/swagger/ui/index#/) using the functions [`lesMaalinger`](../R/lesMaalinger.R) and [`lesVannlokaliteter`](../R/lesVannlokaliteter).
* Geographical information about **water bodies** (_vannforekomster_) of Norway is available from the [Norwegian Environment Agency](https://karteksport.miljodirektoratet.no/). This file has to be downloaded manually.
* Information on the **typology** (characteristics) of the water bodies of Norway is available from the _[vann-nett](https://vann-nett.no/portal/)_ database. This file has to be downloaded manually and then read, together with the previous one, using the function [`lesVannforekomster`](../R/lesVannforekomster.R).
* More detailed characteristics of the **lakes** of Norway (if needed) is available from the _[innsjødatabase](https://www.nve.no/kart/kartdata/vassdragsdata/innsjodatabase/)_. This file has to be downloaded manually and then read using the function [`lesInnsjodatabasen`](../R/lesInnsjodatabasen.R) and combined with the water body information using [`oppdaterVannforekomster`](../R/oppdaterVannforekomster.R).

These datasets and their websites are available in Norwegian only, and a full documentation of the dataflow in English has therefore not been prioritised.
However, the dataflow can be summarised in the following steps, all of which are carried out by the function [`WFD2ECA`](../R/WFD2ECA.R):

1. _Removing measurements that have been taken outside the reporting period for NI._ For ECA, reporting times are assumed to be every third year. The value for 2024 is based on measurements taken in 2022, 2023 and 2024. In order to increase the sample available for modelling, earlier time periods are included as well. Accounting years included are 2012, 2015, 2018 and 2021, each of them representing the three years up to and including the accounting year. Measurements taken before 2010 or after 2024 are thus excluded. For NI, reporting times are the years 1990, 2000, 2010, 2014, 2019 and 2024, where each reporting year is represented by up to ten years up to and including the reporting year.
2. _Removing measurements with values that lie outside the interval for which the indicator is defined._ The _vannmiljø_ database contains several values that are incompatible with the definition of the indicator. These must have been mismeasured or misreported and need to be excluded. In addition, it is possible (and recommended) to exclude other measurements taken by the same operator at the same date.
3. _Identifying the water locality and water body for each measurement._ There may be several measurements per water locality and several water localities per water body. Measurements taken in an unknown water locality or unknown water body are excluded.
4. _Removing measurements that are taken in a water body type for which the indicator is not defined._ For example, if a WFD indicator that is defined for rivers is measured in a lake, this measurement is excluded. Likewise, if a WFD indicator that is defined for lime-poor lakes is measured in a lime-rich lake, this measurement is excluded.
5. _Removing measurements that do not fulfil specific requirements for the indicator._ Some WFD indicators need to be measured in certain months or to be derived from a certain minimum number of measurements per season. These requirements are described in the [Norwegian WFD guidelines](https://www.vannportalen.no/veiledere/klassifiseringsveileder/). Where it is possible to test whether these requirements are met based on data from Vannmiljø, this is done by the function.
6. _Removing measurements for reporting periods with too little data._ A certain minimum sample size is needed to estimate the status for a given reporting period. If the actual sample size is smaller than this threshold, the respective reporting period is omitted, and the measurements taken during this period are excluded. The default used is 200 measurements per ECA accounting period and 100 measurements per NI reporting period.
7. _Scaling measurements to untruncated nEQR values ("mEQR" values)._ According to the WFD and the [Norwegian WFD guidelines](https://www.vannportalen.no/veiledere/klassifiseringsveileder/), measurements of WFD indicators are transformed into so-called **nEQR** values ("normalised Ecological Quality Ratios") between 0 and 1, which correspond to indicator values sensu SEEA&nbsp;EA. This transformation includes a truncation, where measurements that are better than the upper boundary of high ecological status are assigned an nEQR value of 1, and  measurements that are poorer than the lower boundary of bad ecological status are assigned an nEQR value of 0. Truncation, however, destroys information about variation in ecological condition that is important for estimating (modelling and extrapolating) the indicator value and its uncertainty. Therefore, the dataflow from WFD to ECA and NI should be based on values that are _scaled and transformed but not truncated_. According to this approach (described by [Sandvik 2019](http://hdl.handle.net/11250/2631056), pp. 13–15), measurements are first _scaled_ so that values of 0 correspond to the lower boundary of bad ecological status, and values of 1 correspond to the upper boundary of high ecological status; the values obtained are than _transformed_ so that the remaining boundaries between status classes correspond to the normative definitions provided for the respective indicator. The resulting values are here referred to as **mEQR** ("m" for "modified" &ndash; or for the letter/step before "n"). Note that they may be negative or larger than 1 (although it is ensured that no indicator value can be below −0.2 or above 1.2). The mEQR values can be exchanged between WFD and NI. Before they are exchanged between WFD and ECA, they need to be _truncated_ in a final step (see below). After truncation, they are again equal to nEQR values. It is thus only the order of steps that is changed, from truncation&ndash;scaling&ndash;transformation to scaling&ndash;transformation&ndash;aggregation&ndash;truncation. The scaling and transformation is carried out by the function [`mEQR`](../R/mEQR.R).
8. _Fitting a linear model to the measurements._ A linear model is fitted to the mEQR values, with explanatory variables being reporting periods, typology factors and surveillance activities. _Typology factors_ are described in the [Norwegian WFD guidelines](https://www.vannportalen.no/veiledere/klassifiseringsveileder/) and include altitudinal zone, size class, lime content and organic matter content, among others. _Surveillance activities_ describe the management target of each measurement (see [vannmiljø](https://vannmiljokoder.miljodirektoratet.no/activity)). Measurements taken under the WFD can be expected to be biased towards poorer status than the average. Therefore, each measurement is here weighted by the representativeness of its surveillance activity, so as to partially correct for the bias in the data available (see [Sandvik 2019](http://hdl.handle.net/11250/2631056), pp. 17–19, [Framstad et al. 2023](https://hdl.handle.net/11250/3104185), pp. 121–122). Model selection is based on AIC ([Akaikes Information Criterion](https://en.wikipedia.org/wiki/Akaike_information_criterion)).
9. _Averaging measurements taken in the same water body._ If more than one measurement has been taken in the same water body within the same reporting period, the unweighted mean of these measurements is used to represent the water body body.
10. _Extrapolating mEQR values to water bodies that lack data._ If no measurement has been taken in a water body, the most likely indicator value is predicted for this water body, based on the model fitted.
11. _Using simulations to estimate confidence and prediction intervals._ Based on the model fitted and a re-sampling procedure, the uncertainty surrounding the estimates obtained in the previous steps is quantified using confidence intervals for water bodies that have been sampled, and prediction intervals for water bodies that have not been sampled. This is a time-consuming step. For illustration purposes, the number of iterations is limited to 1,000. With so few iterations, the estimates of uncertainty are unreliable, however. For reporting one should, therefore, use more iterations, at least 10,000 (and preferably 100,000).
12. _Aggregating estimates geographically._ The values obtained for water bodies are aggregated for administrative units (municipalities, counties, regions and/or the whole country). Aggregation takes the form of averages weighted by area (for lake water bodies and coastal water bodies) or length (for river water bodies). Note that this step deviates from the WFD, which does not practice aggregation. (Rather, summary statistics following the WFD are provided as the number or proportion of water bodies that fulfil the objectives of the WFD.)

The results obtained are mEQR values (see step 7 above). 
In the context of ECA, these need to be truncated to be no less than 0 and no greater than 1, in order to obtain nEQR values (sensu WFD) or indicator values (sensu SEEA&nbsp;EA). 
This step is accomplished by the function [`trunker`](../R/Funksjon.R). 
In the context of NI, untruncated mEQR values should be reported.

Some WFD indicators are applicable to both river and lake water bodies. 
The values of these indicators need to be estimated separately and, in the case of ECA, to be reported separately. 
For use in NI, the values obtained for rivers and lakes may need to be averaged in order to represent the "freshwater ecosystem" (a step accomplished by the function [`kombiner`](../R/kombiner.R)).

Uploading the data obtained to the NI database requires the [NIcalc](https://github.com/NINAnor/NIcalc) package. 
This procedure involves the function [`oppdaterNImedVF`](../R/oppdaterNImedVF.R) of the current repository and several functions of the NIcalc package.

Further explanations are [available in Norwegian]().
